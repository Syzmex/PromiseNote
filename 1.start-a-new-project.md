# 怎样搭建一个基于 `dva` 的工程

在搭建之前确保已经安装最新版 `nodejs`

## 创建工程目录

安装 `dva` & `roadhog`

```bash
$ npm i dva-cli -g
$ dva -v
0.7.8
```

```bash
$ npm i roadhog -g
$ roadhog -v
0.5.3
```

创建项目

```bash
$ dva new newproject
```

启动项目

```bash
$ cd newproject
$ npm install
$ npm start
```

打开浏览器访问 http://localhost:8000/ 可以看到欢迎界面

> `Mac` 系统, 如果出现权限问题 `permission denied, open '/Users/用户名/.babel.json'`
> 请使用 `sudo chown -R 用户名 ~/.babel.json` 解决


## 目录结构

```bash
.
├── dist                   # 编译结果
├── mock                   # 虚拟数据
├── public                 # 文件夹内所有文件将直接复制到根目录
├── src                    # Source directory
    ├── assets             # Store images, icons, ...
    ├── components         # UI components
    ├── index.css          # CSS for entry file
    ├── index.html         # HTML for entry file
    ├── index.js           # Enry file
    ├── models             # Dva models
    ├── router.js          # Router configuration
    ├── routes             # Route components
    ├── services           # Used for communicate with server
    └── utils              # Utils
        └── request.js     # A util wrapped dva/fetch
├── .editorconfig          #
├── .eslintrc              # Eslint config
├── .gitignore             #
├── .roadhogrc             # Roadhog config
└── package.json           #
```

## 配置文件

由于 `dva` 和 `roadhog` 的版本还没有稳定，用命令生成的新目录不能直接用于开发，需要修改配置文件。

### package.json

关闭启动时自动开启浏览器新页签功能

```diff
  {
    ...
    "scripts": {
-     "start": "roadhog server",
+     "start": "roadhog server --no-open",
    },
    ...
  }
```

安装依赖并添加至 `package.json`

```bash
# antd
$ npm i antd --save
# babel-plugin
$ npm i babel-plugin-import babel-plugin-lodash --save-dev
# webpack-plugin
$ npm i lodash-webpack-plugin html-webpack-plugin --save-dev
```

### webpack.config.js

当前版本 `roadhog` 功能不完善，不过幸好支持读取文件 `webpack.config.js` 修改配置。

```js
import webpack from 'webpack';
import HtmlWebpackPlugin from 'html-webpack-plugin';
import ExtractTextPlugin from 'extract-text-webpack-plugin';
import LodashModuleReplacementPlugin from 'lodash-webpack-plugin';

// 当前 roadhog@0.5.3 版本不提供编译文件名添加 hash 功能
// 必须修改配置添加 hash
export default ( webpackConfig, env ) => {
  
  // lodash 打包配置
  webpackConfig.babel.plugins.push( 'lodash' );
  webpackConfig.plugins.push( new LodashModuleReplacementPlugin() );

  // 生产环境
  if ( env === 'production' ) {

    // webpackConfig.module.loaders = webpackConfig.module.loaders.filter(
    //   loader => loader.test.toString() !== '/\\.html?$/'
    // );
    
    // 输出文件名添加 hash
    webpackConfig.output.filename = '[name].[chunkhash:6].js';
    webpackConfig.output.chunkFilename = '[name].[chunkhash:6].js';

    // 覆盖插件
    webpackConfig.plugins.forEach( ( plugin, index, plugins ) => {

      if ( plugin instanceof ExtractTextPlugin ) {
        plugins[ index ] = new ExtractTextPlugin( '[name].[chunkhash:6].css' );
      }

      else if ( plugin instanceof webpack.optimize.CommonsChunkPlugin ) {
        plugins[ index ] = new webpack.optimize.CommonsChunkPlugin(
          'common',
          'common.[chunkhash:6].js'
        );
      }

    } );

    // moment 精简语言文件
    webpackConfig.plugins.push(
      new webpack.ContextReplacementPlugin( /moment[/\\]locale$/, /zh-cn/ )
    );

    // 生成 index.html
    webpackConfig.plugins.push(
      new HtmlWebpackPlugin( {                            // 根据模板插入 css/js 等生成最终HTML
        // favicon: './logo/logo.ico',                    // favicon 路径
        template: './src/entries/index_production.html',  // html模板路径
        filename: 'index.html',                           // 生成的html存放路径，相对于 path
        inject: true                                      // 允许插件修改哪些内容，包括 head 与 body

        // 方便实施人员修改配置 index.html 不压缩
        // minify: {                    // 压缩HTML文件
        //   removeComments: false,     // 移除HTML中的注释
        //   collapseWhitespace: false  // 删除空白符与换行符
        // }
      } )
    );

  }

  return webpackConfig;
};

```

> 详细的 `webpack` 配置参考 `roadhog` 的 [webpack配置](https://github.com/sorrycc/roadhog/tree/master/src/config)
>
> 注：官方不推荐此方法修改配置，因为不便于以后的完美升级。
> 当根目录存在 `webpack.config.js` 文件时，运行服务会有警告。

### .roadhogrc

添加 `antd` 插件和 `theme` 配置

> 详细文档参考 [https://github.com/sorrycc/roadhog](https://github.com/sorrycc/roadhog)
> 
> 不喜欢 `json` 格式的配置，可以改名为 `.roadhogrc.js` 使用 `javascript` 语法
> 支持 `es6` 语法

```diff
  {
    ...
+   "theme": "antd.config.js",
    "env": {
      "development": {
        "extraBabelPlugins": [
          ...
+         [ "import", { "libraryName": "antd", "style": true } ]
        ]
      },
      "production": {
        "extraBabelPlugins": [
          ...
+         [ "import", { "libraryName": "antd", "style": true } ]
        ]
      }
    },
    ...
  }
```

### antd.config.js

`antd` 主题相关配置

> 相关文档参考 [https://ant.design/docs/react/customize-theme-cn](https://ant.design/docs/react/customize-theme-cn)
> 不支持 `es6`

```js
const path = require( 'path' );

module.exports = function getConfig() {
  return {
    // antd 自带图标字体本地化
    'icon-url': `"${path.relative( './~/antd/lib/style/*', './src/assets/fonts/iconfont' )}"`
  };
};
```

复制字体文件到 `./src/assets/fonts/` 文件夹

### .eslintrc

编辑器语法检查配置。

> 统一团队代码风格，调试方便，提高开发效率

```diff
  {
    ...
-   "extends": "airbnb",
+   "extends": [
+     "airbnb",
+     "./eslint.config.js"
+   ],
    ...
  }
```

新增文件 `eslint.config.js`，除了 `react/sort-comp` 其他可以按照自己的书写习惯适当修改

> 详细文档请访问 [http://eslint.org/docs/user-guide/configuring](http://eslint.org/docs/user-guide/configuring)

```js
module.exports = {
  rules: {
    'brace-style': [ 1, 'stroustrup', { allowSingleLine: true } ],
    'comma-spacing': [ 2, { before: false, after: true } ],
    indent: [ 0, 2, { VariableDeclarator: 0 } ],
    'one-var-declaration-per-line': 0,
    'space-before-function-paren': 0,
    'comma-dangle': [ 2, 'never' ],
    'computed-property-spacing': 0,
    'no-multiple-empty-lines': 0,
    'template-curly-spacing': 0,
    'array-bracket-spacing': 0,
    'no-use-before-define': 0,
    'no-underscore-dangle': 0,
    'no-trailing-spaces': 0,
    'no-negated-in-lhs': 0,
    'no-param-reassign': 0,
    'object-shorthand': 0,
    'space-in-parens': 0,
    'padded-blocks': 0,
    'func-names': 0,
    'no-console': 0,
    'no-shadow': 0,
    'eol-last': 0,
    'one-var': 0,
    'new-cap': 0,
    'no-var': 0,
    'max-len': 1,
    'react/prop-types': 0,
    'react/no-did-mount-set-state': 0,
    'react/prefer-stateless-function': 0,
    'react/jsx-closing-bracket-location': [ 1, {
      selfClosing: 'after-props',
      nonEmpty: 'after-props'
    } ],
    'react/sort-comp': [ 1, {
      order: [
        'static-methods',
        'lifecycle',
        '/^handle.+$/',
        'everything-else',
        'render'
      ],
      groups: {
        rendering: [
          '/^render.+$/',
          'render'
        ]
      }
    } ]
  }
};
```

## Hello World

1. `public/index.html`
    
  ```html
    <!DOCTYPE html>
    <html lang="en">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <title>Hello World</title>
      <link rel="stylesheet" href="index.css" />
    </head>
    <body>
    
    <div id="root"></div>
    
    <script src="index.js"></script>
    
    </body>
    </html>
    
  ```

2. `src/router.js`

  ```js
    import React from 'react';
    import { Router, Route } from 'dva/router';
    import IndexPage from './routes/IndexPage';
    
    function RouterConfig({ history }) {
      return (
        <Router history={history}>
          <Route path="/" component={IndexPage} />
        </Router>
      );
    }
    
    export default RouterConfig;
  ```

3. `src/routes/indexPage.jsx`

  ```js
    import React from 'react';
    import { connect } from 'dva';
    
    function IndexPage() {
      return (
        <div style={{ textAlign: 'center' }}>
          <h1>Hello World</h1>
        </div>
      );
    }
    
    IndexPage.propTypes = {
    };
    
    export default connect()(IndexPage);
  ```
  
4. `src/index.js`

  ```js
    import dva from 'dva';
    import './index.css';
    
    // 1. Initialize
    const app = dva();
    
    // 2. Plugins
    // app.use({});
    
    // 3. Model
    // app.model(require('./models/example'));
    
    // 4. Router
    app.router(require('./router'));
    
    // 5. Start
    app.start('#root');
  ```

```bash
$ npm start
```

打开浏览器访问 http://localhost:8000/ 可以看到 `Hello World`



