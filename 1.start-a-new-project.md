# 开始一个新项目

## 怎么使用搭建一个基于 `dva` 的项目

在搭建之前确保已经安装最新版 `nodejs`

### 安装 `dva` & `roadhog`

```bash
$ npm i dva-cli -g
$ dva -v
0.7.8
```

```bash
$ npm i roadhog -g
$ roadhog -v
0.5.3
```

### 创建项目

```bash
$ dva new newproject
```

### 启动项目

```bash
$ cd newproject
$ npm install
$ npm start
```

打开浏览器访问 http://localhost:8000/ 可以看到欢迎界面

> ps
>
> 每次启动都会自动打开一个新的浏览器
> 如果觉得很麻烦可以再 `package.json` 文件中修改 `script -> start` 为 `roadhog server --no-open`
>
> `Mac` 系统, 如果出现权限问题 `permission denied, open '/Users/用户名/.babel.json'`
> 请使用 `sudo chown -R 用户名 ~/.babel.json` 解决


## 创建项目文件

### 目录结构

```bash
.
├── dist                   # 编译结果
├── mock                   # 虚拟数据
├── public                 # 文件夹内所有文件将直接复制到根目录
├── src                    # Source directory
    ├── assets             # Store images, icons, ...
    ├── components         # UI components
    ├── index.css          # CSS for entry file
    ├── index.html         # HTML for entry file
    ├── index.js           # Enry file
    ├── models             # Dva models
    ├── router.js          # Router configuration
    ├── routes             # Route components
    ├── services           # Used for communicate with server
    └── utils              # Utils
        └── request.js     # A util wrapped dva/fetch
├── .editorconfig          #
├── .eslintrc              # Eslint config
├── .gitignore             #
├── .roadhogrc             # Roadhog config
└── package.json           #
```

### 新项目准备

由于 `dva` 和 `roadhog` 的版本还没有稳定，用命令生成的新目录不能直接用于开发，需要修改配置文件。

#### package.json

关闭启动时自动开启浏览器新页签功能

```diff
{
  ...
  "scripts": {
    - "start": "roadhog server",
    + "start": "roadhog server --no-open",
  },
  ...
}
```

安装依赖并添加至 `package.json`

```bash
# antd
$ npm i antd --save
# babel-plugin
$ npm i babel-plugin-import babel-plugin-lodash --save-dev
# webpack-plugin
$ npm i lodash-webpack-plugin html-webpack-plugin --save-dev
```

#### webpack.config.js

当前版本 `roadhog` 功能不完善，不过幸好支持读取文件 `webpack.config.js` 修改配置。

```js
import webpack from 'webpack';
import HtmlWebpackPlugin from 'html-webpack-plugin';
import ExtractTextPlugin from 'extract-text-webpack-plugin';
import LodashModuleReplacementPlugin from 'lodash-webpack-plugin';

// 当前 roadhog@0.5.3 版本不提供编译文件名添加 hash 功能
// 必须修改配置添加 hash
export default ( webpackConfig, env ) => {
  
  // lodash 打包配置
  webpackConfig.babel.plugins.push( 'lodash' );
  webpackConfig.plugins.push( new LodashModuleReplacementPlugin() );

  // 生产环境
  if ( env === 'production' ) {

    // webpackConfig.module.loaders = webpackConfig.module.loaders.filter(
    //   loader => loader.test.toString() !== '/\\.html?$/'
    // );
    
    // 输出文件名添加 hash
    webpackConfig.output.filename = '[name].[chunkhash:6].js';
    webpackConfig.output.chunkFilename = '[name].[chunkhash:6].js';

    // 覆盖插件
    webpackConfig.plugins.forEach( ( plugin, index, plugins ) => {

      if ( plugin instanceof ExtractTextPlugin ) {
        plugins[ index ] = new ExtractTextPlugin( '[name].[chunkhash:6].css' );
      }

      else if ( plugin instanceof webpack.optimize.CommonsChunkPlugin ) {
        plugins[ index ] = new webpack.optimize.CommonsChunkPlugin(
          'common',
          'common.[chunkhash:6].js'
        );
      }

    } );

    // moment 精简语言文件
    webpackConfig.plugins.push(
      new webpack.ContextReplacementPlugin( /moment[/\\]locale$/, /zh-cn/ )
    );

    // 生成 index.html
    webpackConfig.plugins.push(
      new HtmlWebpackPlugin( {                            // 根据模板插入 css/js 等生成最终HTML
        // favicon: './logo/logo.ico',                    // favicon 路径
        template: './src/entries/index_production.html',  // html模板路径
        filename: 'index.html',                           // 生成的html存放路径，相对于 path
        inject: true                                      // 允许插件修改哪些内容，包括 head 与 body

        // 方便实施人员修改配置 index.html 不压缩
        // minify: {                    // 压缩HTML文件
        //   removeComments: false,     // 移除HTML中的注释
        //   collapseWhitespace: false  // 删除空白符与换行符
        // }
      } )
    );

  }

  return webpackConfig;
};

```

>注：官方不推荐此方法修改配置，因为不便于以后的完美升级。
>当根目录存在 `webpack.config.js` 文件时，运行服务会有警告。



